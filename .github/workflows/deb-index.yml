name: Stable Packages Generator
on:
  push:
    paths:
      - 'debs/**'  # Trigger on changes to debs/ and its subfolders

jobs:
  generate-packages:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}  # Ensure PAT has "repo" permissions

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y dpkg-dev apt-utils gzip  # Installs apt-ftparchive

      - name: Generate Packages files
        run: |
          rm -f Packages*  # Delete old index files
          # Generate config for apt-ftparchive
          echo 'APT { FTPArchive { Packages { Extensions ".deb"; Compress ". gz"; ShowAll "yes"; }; }; }' > apt.conf
          # Scan debs/ directory and generate index
          apt-ftparchive -c=apt.conf packages debs/ > Packages
          gzip Packages  # Compress the index

      - name: Commit and push
        run: |
          git config user.name "Auto Packages Bot"
          git config user.email "bot@example.com"
          git add Packages Packages.gz
          git commit -m "Auto: Update Packages ($(date +%Y%m%d%H%M%S))" || true
          git push origin main
