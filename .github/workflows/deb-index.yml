name: Auto-Update Packages Index

on:
  push:
    paths:
      - 'repo/**'  # ä»…å½“ repo ç›®å½•å†…å®¹å˜æ›´æ—¶è§¦å‘
    branches: [ main ]

jobs:
  generate_packages:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤ 1ï¼šæ£€å‡ºä»£ç 
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}

      # æ­¥éª¤ 2ï¼šå®‰è£…ä¾èµ–å·¥å…·
      - name: Install dpkg-scanpackages
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev

      # æ­¥éª¤ 3ï¼šç”Ÿæˆ Packages æ–‡ä»¶åˆ°æ ¹ç›®å½•
      - name: Generate Packages Index
        run: |
          # è¿›å…¥ deb æ–‡ä»¶ç›®å½•
          cd repo
          
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨ .deb æ–‡ä»¶
          if [ $(ls *.deb 2>/dev/null | wc -l) -eq 0 ]; then
            echo "é”™è¯¯ï¼šrepo ç›®å½•ä¸­æ²¡æœ‰æ‰¾åˆ° .deb æ–‡ä»¶"
            exit 1
          fi
          
          # åœ¨æ ¹ç›®å½•ç”Ÿæˆ Packages æ–‡ä»¶
          dpkg-scanpackages . /dev/null > ../Packages
          cd ..  # è¿”å›æ ¹ç›®å½•
          
          # ç”Ÿæˆå‹ç¼©æ–‡ä»¶
          gzip -k -f Packages
          echo "ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨:"
          ls -l Packages*

      # æ­¥éª¤ 4ï¼šæäº¤æ›´æ–°åˆ°æ ¹ç›®å½•
      - name: Commit & Push Changes
        run: |
          # é…ç½® Git
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions-bot@users.noreply.github.com"
          
          # æ·»åŠ ç´¢å¼•æ–‡ä»¶
          git add Packages*
          
          # æ£€æŸ¥å˜æ›´
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "ğŸ”§ Auto-Update: Packages Index"
            git push origin main
            echo "ç´¢å¼•æ–‡ä»¶å·²æ›´æ–°"
          else
            echo "æ— ç´¢å¼•æ–‡ä»¶å˜æ›´"
          fi
