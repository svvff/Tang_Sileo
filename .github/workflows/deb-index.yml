name: Auto Generate Packages File
on:
  push:
    paths:
      - 'debs/**'  # 仅监听 debs 目录变动

jobs:
  generate-packages:
    runs-on: ubuntu - latest
    steps:
      - name: Checkout repository with PAT
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}  # 显式使用 PAT 检出代码

      - name: Install necessary tools
        run: sudo apt - get update && sudo apt - get install - y dpkg - dev apt - utils  # 安装 dpkg - dev（生成 Packages 所需）和 apt - utils（含 apt - ftparchive）

      - name: Generate Packages and Release files
        run: |
          # 生成压缩和未压缩的 Packages 文件
          dpkg - scanpackages debs/ /dev/null | gzip > Packages.gz
          dpkg - scanpackages debs/ /dev/null > Packages
          # 生成 Release 文件（-o 参数指定输出文件名，. 表示当前目录）
          apt - ftparchive release - o Release .

      - name: Configure Git credentials
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git remote set - url origin "https://${{ secrets.PAT }}@github.com/${{ github.repository }}.git"

      - name: Commit and push changes
        run: |
          git add Packages Packages.gz Release  # 添加 Release 文件
          git commit - m "Auto - generate Packages and Release files" || echo "No changes to commit"
          git push origin main
