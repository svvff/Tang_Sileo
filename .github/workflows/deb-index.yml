name: Auto Generate Multi-Architecture Packages
on:
  push:
    paths:
      - 'debs/**'  # 监听所有架构目录的变动
jobs:
  generate-packages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with PAT
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev gzip

      - name: Generate multi-arch Packages
        run: |
          rm -f Packages*  # 清除旧索引
          # 递归扫描所有子目录，自动识别架构
          dpkg-scanpackages -m --recursive debs/ /dev/null | tee >(gzip > Packages.gz)
          # 验证生成结果（可选）
          ls -l Packages* && cat Packages | grep -i 'architecture:'

      - name: Push changes
        run: |
          git add Packages Packages.gz
          git commit -m "Update multi-arch Packages ($(date))" || true
          git push origin main
