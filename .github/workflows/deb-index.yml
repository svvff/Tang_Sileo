name: Auto-Update Packages Index

on:
  push:
    paths:
      - 'repo/**'  # 仅当 repo 目录内容变更时触发
    branches: [ main ]

jobs:
  generate_packages:
    runs-on: ubuntu-latest
    steps:
      # 步骤 1：检出代码
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}  # 使用 PAT 保证推送权限

      # 步骤 2：安装依赖工具
      - name: Install dpkg-scanpackages
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev

      # 步骤 3：生成 Packages 文件
      - name: Generate Packages Index
        run: |
          cd repo
          dpkg-scanpackages . /dev/null > Packages
          gzip -k -f Packages       # 生成 Packages.gz

      # 步骤 4：提交更新
      - name: Commit & Push Changes
        run: |
          git config --global user.name "GitHub Actions Bot"
          git add Packages*
          git commit -m "Auto-Update: Packages Index"
          git push origin main
